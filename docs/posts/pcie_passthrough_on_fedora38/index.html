<!DOCTYPE html>
<html lang="en-gb" dir="ltr">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>PCIe Passthrough on Fedora 38 | the website of dan donoghue</title>

      <link rel="stylesheet" href="/css/main.min.09d76cae57e2b70cddfd9e088c87da2388439d1479f7285714bf316d3d26daf3.css" integrity="sha256-Cddsrlfitwzd/Z4IjIfaI4hDnRR59yhXFL8xbT0m2vM=" crossorigin="anonymous">


        <script src="/js/main.23cd0c7d837263b9eaeb96ee2d9ccfa2969daa3fa00fa1c1fe8701a9b87251a1.js" integrity="sha256-I80MfYNyY7nq65buLZzPopadqj&#43;gD6HB/ocBqbhyUaE=" crossorigin="anonymous"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <header class="links">
	<a href="/"><img src="/home.png" /></a>
	<a href="https://uk.linkedin.com/in/daniel-donoghue-91349598"><img src="/linkedin.png" /></a>
	<a href="https://www.github.com/DanDonoghue"><img src="/github-mark.png" /></a>
    <a href="/about-me"><img src="/about.png"></a>
</header>

<header class="title">
	<h1><a href="/posts/pcie_passthrough_on_fedora38/">pcie passthrough on fedora 38</a></h1>
	<p>Saturday, 20/05/2023 10:00 UTC</p>
</header>

  </header>
  <main>
    
  <p>This is a lot simpler these days with modern-ish cards and a modern-ish OS because nVidia&rsquo;s lifted their wanky restrictions in their drivers. Unfortunately they haven&rsquo;t backported this change for cards from the Windows XP era which kind of sucks but fair enough, it is proper ancient.</p>
<p>For a single GPU passed through to one Windows XP virtual machine, I just had to add a &ldquo;PCI Host Device&rdquo; in virt-manager.. typically two actually, one for the GPU function 0, and one for the GPU&rsquo;s HDMI audio function 1. Once that&rsquo;s done, change the <code>Video</code> model to <code>none</code> and edit the VM&rsquo;s XML to look like the following.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;domain</span> <span style="color:#a6e22e">xmlns:qemu=</span><span style="color:#e6db74">&#34;http://libvirt.org/schemas/domain/qemu/1.0&#34;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;kvm&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;features&gt;</span>
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;hyperv</span> <span style="color:#a6e22e">mode=</span><span style="color:#e6db74">&#34;custom&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;vendor_id</span> <span style="color:#a6e22e">state=</span><span style="color:#e6db74">&#34;on&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;1234567890ab&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/hyperv&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;kvm&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;hidden</span> <span style="color:#a6e22e">state=</span><span style="color:#e6db74">&#34;on&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/kvm&gt;</span>
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/features&gt;</span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;qemu:override&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;qemu:device</span> <span style="color:#a6e22e">alias=</span><span style="color:#e6db74">&#34;hostdev0&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;qemu:frontend&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;qemu:property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;x-vga&#34;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;bool&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/qemu:frontend&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/qemu:device&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/qemu:override&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/domain&gt;</span></span></span></code></pre></div>
<p>This XML will make KVM hide that it&rsquo;s a VM just enough for the nVidia driver to not throw a hissy. This is enough for passing through a 2nd GPU to a single VM, but I want more. I want to be able to play classic LAN multiplayer games on two VMs because I forgot how much effort it is running Windows XP on a physical computer. With VMs, I can use backing disk images to revert any changes so if I install something that breaks the OS it&rsquo;s only a couple commands to get something usable back.</p>
<p>Now, the hard part was IOMMU grouping. For some reason, the 2nd GPU was being put into a group with a bunch of other random shit that made it refuse to pass through. This took a little bit of effort to sort out, with the help of <a href="https://github.com/some-natalie/fedora-acs-override">this repo</a>. Follow the readme instructions, I opted to download the prebuild kernel (hint: you gotta be logged in to GitHub to download the build artefacts). Obviously, this work around will compromise stability and security and all that jizz, but this is just a fuck around thing to play a couple old games.</p>
<p>Once the patched kernel&rsquo;s installed, if you reboot and <strong>highlight</strong> the boot option with <code>acs</code> in the kernel version and then press <strong>e</strong> to edit it and add <code>pcie_acs_override=downstream,multifunction</code> then with any luck when you boot you&rsquo;re 2nd graphics card will be in it&rsquo;s own IOMMU group and be available for passthrough. If you want this option to be permanent then add it to <code>/etc/default/grub</code> otherwise you&rsquo;ll have to edit the boot commands every time.</p>
<p>I have 3x graphics cards installed on this system, a GTX 1060 6GB, a GT 710, and a 9500GT. The GT 710 ran solid with no issues at all, but the 9500GT would occasionally hang the system is you rebooted the VM. I could do with replacing it with something newer but it&rsquo;s perfectly capable of running the kind of games I&rsquo;ll be playing, plus it&rsquo;s a single slot GPU that fits in my bottom x16 slot.</p>
<p>Here&rsquo;s a video of how it looks at the end of it all</p>
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading="eager" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/sbxhLOQTu_k?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="YouTube video"></iframe>
    </div>



  </main>
  <footer>
    <div class="copyright">
    <p>&copy; dan donoghue 2016-present. contents and theme licensed under <a href="/LICENSE" target="_blank">apache 2.0</a>. source available on <a href="https://github.com/DanDonoghue/dandonoghue.github.io" target="_blank">github</a></p>
</div>
  </footer>
</body>
</html>
